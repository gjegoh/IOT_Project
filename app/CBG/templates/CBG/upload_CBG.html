{% extends 'CBG/base.html' %}
{% load static %}

{% block head %}
{% block title %}Upload Readings{% endblock %}
{% endblock %}

{% block body %}
{% if user.is_authenticated %}
<div id="uploadCBGMain">
    <!-- Navbar -->
    <div class="header">
        <h1>Upload Page</h1>
        <nav class="navbar navbar-expand-lg navbar-light justify-content-center">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item menu-aligner">
                        <i class="fa-solid fa-house"></i>
                        <a href="{% url 'Main:index' %}" class="nav-link">Dashboard</a>
                    </li>
                    <li class="nav-item menu-aligner">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <a href="{% url 'Main:logout' %}" class="nav-link">Log Out</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- End of Navbar -->

    <!-- Upload Area -->
    <div>
        <form method="POST" action="{% url 'CBG:upload_CBG' %}" enctype='multipart/form-data'>
            {% csrf_token %}
            <div class="container-fluid">
                <div class="row">
                    <div class="col d-flex justify-content-end">
                        <div id="uploadArea" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">1</span> CBG Reading <br> (Before Meal)</h1>
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo" class="uploaded-file__info">
                                        <span class="uploaded-file__name">Project 1</span>
                                        <span class="uploaded-file__counter">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker" name="datetimepicker" value="">
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading">Reading</label>
                                    <input id="reading" name="reading" type="number" class="form-control">
                                </div>
                                <div class="form-group formFields">
                                    <label for="measurement">Units</label>
                                    <select class="form-control" id="measurement" name="measurement">
                                        <option value="mgdL">mg/dL</option>
                                        <option value="mmolL">mmol/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col d-flex justify-content-center">
                        <div id="uploadArea2" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">2</span> Food Image</h1>
    
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon2" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText2" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage2" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput2" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails2" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile2" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo2" class="uploaded-file__info">
                                        <span class="uploaded-file__name2">Project 1</span>
                                        <span class="uploaded-file__counter2">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker2" name="datetimepicker2" value="">
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading2">Calorie (kcal)</label>
                                    <input id="reading2" name="reading2" type="number" class="form-control">
                                </div>
                                <div class="form-group formFields">
                                    <label for="reading3">Carbs (g)</label>
                                    <input id="reading3" name="reading3" type="number" class="form-control">
                                </div>
                                <br>
                                <div class="form-group formFields">
                                    <label for="reading4">Sugar (g)</label>
                                    <input id="reading4" name="reading4" type="number" class="form-control">
                                </div>
                                <div class="form-group formFields">
                                    <label for="reading5">Fibre (g)</label>
                                    <input id="reading5" name="reading5" type="number" class="form-control">
                                </div>
                            </div>
                            <br>
                            <!-- <label for="reading7">Name</label> -->
                            <input id="reading7" name="reading7" type="text" class="form-control" placeholder="Enter food here!">
                        </div>
                    </div>
                    <div class="col d-flex justify-content-start">
                        <div id="uploadArea3" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">3</span> CBG Reading <br> (After Meal)</h1>
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon3" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText3" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage3" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput3" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails3" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile3" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo3" class="uploaded-file__info">
                                        <span class="uploaded-file__name3">Project 1</span>
                                        <span class="uploaded-file__counter3">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker3" name="datetimepicker3" value="" >
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading6">Reading</label>
                                    <input id="reading6" name="reading6" type="number" class="form-control">
                                </div>
                                <div class="form-group formFields">
                                    <label for="measurement2">Units</label>
                                    <select class="form-control" id="measurement2" name="measurement2">
                                        <option value="mgdL">mg/dL</option>
                                        <option value="mmolL">mmol/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="submitBtn" class="mt-3 btn btn-primary" type="submit">Upload</button>
                </div>
            </div>
        </form>
    </div>
    <!-- End Upload Area -->

    <!-- Start of Tele Button Test -->
    <div>
        <input id="CHAT_ID" value="{{ CHAT_ID }}" type="hidden" />
        <input id="TELE_TOKEN" value="{{ TELE_TOKEN }}" type="hidden" />
        <button class="btn-primary btn" onclick="exceedThresholdTeleMsg()">Reminder Tele Msg</button>
    </div>
    <!-- End of Tele Button Test -->
{% else %}
<h1>Index Page</h1>
    <p>You are not logged in</p>
    <a href="{% url 'Main:login' %}">Log In</a>
{% endif %}
</div>
<script>
    // Select Upload-Area
    const uploadArea = document.querySelector('#uploadArea');
    const uploadArea2 = document.querySelector('#uploadArea2');
    const uploadArea3 = document.querySelector('#uploadArea3');
    // Select Drop-Zoon Area
    const dropZoon = document.querySelector('#dropZoon');
    const dropZoon2 = document.querySelector('#dropZoon2');
    const dropZoon3 = document.querySelector('#dropZoon3');
    // Loading Text
    const loadingText = document.querySelector('#loadingText');
    const loadingText2 = document.querySelector('#loadingText2');
    const loadingText3 = document.querySelector('#loadingText3');
    // Slect File Input 
    const fileInput = document.querySelector('#fileInput');
    const fileInput2 = document.querySelector('#fileInput2');
    const fileInput3 = document.querySelector('#fileInput3');
    // Select Preview Image
    const previewImage = document.querySelector('#previewImage');
    const previewImage2 = document.querySelector('#previewImage2');
    const previewImage3 = document.querySelector('#previewImage3');
    // File-Details Area
    const fileDetails = document.querySelector('#fileDetails');
    const fileDetails2 = document.querySelector('#fileDetails2');
    const fileDetails3 = document.querySelector('#fileDetails3');
    // Uploaded File
    const uploadedFile = document.querySelector('#uploadedFile');
    const uploadedFile2 = document.querySelector('#uploadedFile2');
    const uploadedFile3 = document.querySelector('#uploadedFile3');
    // Uploaded File Info
    const uploadedFileInfo = document.querySelector('#uploadedFileInfo');
    const uploadedFileInfo2 = document.querySelector('#uploadedFileInfo2');
    const uploadedFileInfo3 = document.querySelector('#uploadedFileInfo3');
    // Uploaded File Name
    const uploadedFileName = document.querySelector('.uploaded-file__name');
    const uploadedFileName2 = document.querySelector('.uploaded-file__name2');
    const uploadedFileName3 = document.querySelector('.uploaded-file__name3');
    // Uploaded File Counter
    const uploadedFileCounter = document.querySelector('.uploaded-file__counter');
    const uploadedFileCounter2 = document.querySelector('.uploaded-file__counter2');
    const uploadedFileCounter3 = document.querySelector('.uploaded-file__counter3');
    // ToolTip Data
    const toolTipData = document.querySelectorAll('.upload-area__tooltip-data');
    // Images Types
    const imagesTypes = [ "jpeg", "png", "svg"]
    // Append Images Types Array Inisde Tooltip Data
    for (var i of toolTipData) {
        i.innerHTML = [...imagesTypes].join(', .');
    }

    // When (drop-zoon) has (dragover) Event 
    dropZoon.addEventListener('dragover', function (event) {
        // Prevent Default Behavior 
        event.preventDefault();
        // Add Class (drop-zoon--over) On (drop-zoon)
        dropZoon.classList.add('drop-zoon--over');
    })
    dropZoon2.addEventListener('dragover', function (event) {
        event.preventDefault();
        dropZoon2.classList.add('drop-zoon--over');
    })
    dropZoon3.addEventListener('dragover', function (event) {
        event.preventDefault();
        dropZoon3.classList.add('drop-zoon--over');
    })

    // When (drop-zoon) has (dragleave) Event 
    dropZoon.addEventListener('dragleave', function () {
        // Remove Class (drop-zoon--over) from (drop-zoon)
        dropZoon.classList.remove('drop-zoon--over');
    })
    dropZoon2.addEventListener('dragleave', function () {
        dropZoon2.classList.remove('drop-zoon--over');
    })
    dropZoon3.addEventListener('dragleave', function () {
        dropZoon3.classList.remove('drop-zoon--over');
    })

    // When (drop-zoon) has (click) Event 
    dropZoon.addEventListener('click', function () {
    // Click The (fileInput)
        fileInput.click();
    })
    dropZoon2.addEventListener('click', function () {
        fileInput2.click();
    })
    dropZoon3.addEventListener('click', function () {
        fileInput3.click();
    })

    // When (fileInput) has (change) Event 
    fileInput.addEventListener('change', function (event) {
        // Select The Chosen File
        const file = event.target.files[0];
        // Call Function uploadFile(), And Send To Her The Chosen File :)
        uploadFile(file);
    })
    fileInput2.addEventListener('change', function (event) {
        const file = event.target.files[0];
        uploadFile2(file);
    })
    fileInput3.addEventListener('change', function (event) {
        const file = event.target.files[0];
        uploadFile3(file);
    })

    var now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    now.setMilliseconds(null)
    now.setSeconds(null)
    
    $('#dateTimePicker2,#dateTimePicker3').val(now.toISOString().slice(0, -1));
    $('#dateTimePicker').val(subtractHours(now, 2).toISOString().slice(0, -1));

    $('form').on('submit', function(event) {
        var input_lst = [
            'reading',
            'reading2',
            'reading3',
            'reading4',
            'reading5',
            'reading6',
            'reading7'
        ]
        var check_forms = true
        for (var i of input_lst) {
            if ($('#' + i).val() == "") {
                check_forms = false
                break
            }
        }
        if (!check_forms) {
            event.preventDefault()
            alert('Please fill up all the input fields!')
            return
        }
    })

    const teleToken = $("#TELE_TOKEN").val();
    const chatID = $("#CHAT_ID").val();
    const telegramURL = 'https://api.telegram.org/bot';

    var readings = {{readings|safe}}
    var cbg_datetime = {{cbg_datetime|safe}}
    // console.log(readings)
    // console.log(cbg_datetime)

    logBook = {}
    temp = []
    for (let i = 0; i < cbg_datetime.length; i++){
        dateKey = cbg_datetime[i].split(',')[0]
        if (logBook[dateKey] == undefined){
            logBook[dateKey] = []
        }
        logBook[dateKey].push(readings[i])
    }

    console.log(logBook[Object.keys(logBook)[Object.keys(logBook).length - 1]])
    checkStatsForToday(logBook[Object.keys(logBook)[Object.keys(logBook).length - 1]]); //Gets last record, supposingly today
    //https://www.diabetes.co.uk/diabetes_care/blood-sugar-level-ranges.html

//Functions can all be found in ../static/CBG/js/script.js
</script>
{% endblock %}

