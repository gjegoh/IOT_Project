{% extends 'CBG/base.html' %}
{% load static %}

{% block head %}
{% block title %}Upload Readings{% endblock %}
{% endblock %}

{% block body %}
{% if user.is_authenticated %}
<div id="uploadCBGMain">
    <!-- Navbar -->
    <div class="header">
        <h1>Upload Page</h1>
        <nav class="navbar navbar-expand-lg navbar-light justify-content-center">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item menu-aligner">
                        <i class="fa-solid fa-house"></i>
                        <a href="{% url 'Main:index' %}" class="nav-link">Dashboard</a>
                    </li>
                    <li class="nav-item menu-aligner">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <a href="{% url 'Main:logout' %}" class="nav-link">Log Out</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- End of Navbar -->

    <!-- Upload Area -->
    <div>
        <form method="POST" action="{% url 'CBG:upload_CBG' %}" enctype='multipart/form-data'>
            {% csrf_token %}
            <div class="container-fluid">
                <div class="row">
                    <div class="col d-flex justify-content-end">
                        <div id="uploadArea" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">1</span> CBG Reading <br> (Before Meal)</h1>
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo" class="uploaded-file__info">
                                        <span class="uploaded-file__name">Project 1</span>
                                        <span class="uploaded-file__counter">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker" name="datetimepicker" value="">
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading">Reading</label>
                                    <input id="reading" name="reading" type="number" class="form-control" step=".1">
                                </div>
                                <div class="form-group formFields">
                                    <label for="measurement">Units</label>
                                    <select class="form-control" id="measurement" name="measurement">
                                        <option value="mgdL">mg/dL</option>
                                        <option value="mmolL">mmol/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col d-flex justify-content-center">
                        <div id="uploadArea2" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">2</span> Food Image</h1>
    
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon2" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText2" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage2" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput2" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails2" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile2" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo2" class="uploaded-file__info">
                                        <span class="uploaded-file__name2">Project 1</span>
                                        <span class="uploaded-file__counter2">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker2" name="datetimepicker2" value="">
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading2">Calorie (kcal)</label>
                                    <input id="reading2" name="reading2" type="number" class="form-control" step=".1">
                                </div>
                                <div class="form-group formFields">
                                    <label for="reading3">Carbs (g)</label>
                                    <input id="reading3" name="reading3" type="number" class="form-control" step=".1">
                                </div>
                                <br>
                                <div class="form-group formFields">
                                    <label for="reading4">Sugar (g)</label>
                                    <input id="reading4" name="reading4" type="number" class="form-control" step=".1">
                                </div>
                                <div class="form-group formFields">
                                    <label for="reading5">Fibre (g)</label>
                                    <input id="reading5" name="reading5" type="number" class="form-control" step=".1">
                                </div>
                            </div>
                            <br>
                            <!-- <label for="reading7">Name</label> -->
                            <input id="reading7" name="reading7" type="text" class="form-control" placeholder="Enter food here!">
                        </div>
                    </div>


                    <div id="label-container"></div>
                    
                    <div class="col d-flex justify-content-start">
                        <div id="uploadArea3" class="upload-area">
                            <!-- Header -->
                            <div class="upload-area__header">
                                <h1 class="upload-area__title"><span class="badge badge-primary">3</span> CBG Reading <br> (After Meal)</h1>
                                <p class="upload-area__paragraph">
                                File should be an image
                                <strong class="upload-area__tooltip">
                                    Like
                                    <span class="upload-area__tooltip-data"></span> <!-- Data Will be Comes From Js -->
                                </strong>
                                </p>
                            </div>
                            <!-- End Header -->
                        
                            <!-- Drop Zoon -->
                            <div id="dropZoon3" class="upload-area__drop-zoon drop-zoon">
                                <span class="drop-zoon__icon">
                                <i class='bx bxs-file-image'></i>
                                </span>
                                <p class="drop-zoon__paragraph">Click to browse</p>
                                <span id="loadingText3" class="drop-zoon__loading-text">Please Wait</span>
                                <img src="" alt="Preview Image" id="previewImage3" class="drop-zoon__preview-image" draggable="false">
                                <input name="fileInput" type="file" id="fileInput3" class="drop-zoon__file-input" accept="image/*">
                            </div>
                            <!-- End Drop Zoon -->
                        
                            <!-- File Details -->
                            <div id="fileDetails3" class="upload-area__file-details file-details">
                                <h3 class="file-details__title">Uploaded File</h3>
                        
                                <div id="uploadedFile3" class="uploaded-file">
                                    <div class="uploaded-file__icon-container">
                                        <i class='bx bxs-file-blank uploaded-file__icon'></i>
                                        <span class="uploaded-file__icon-text"></span> <!-- Data Will be Comes From Js -->
                                    </div>
                            
                                    <div id="uploadedFileInfo3" class="uploaded-file__info">
                                        <span class="uploaded-file__name3">Project 1</span>
                                        <span class="uploaded-file__counter3">0%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Details -->
            
                            <div class="mt-3">
                                <input type="datetime-local" id="dateTimePicker3" name="datetimepicker3" value="" >
                            </div>
            
                            <div class="manualFormBox">
                                <div class="form-group formFields">
                                    <label for="reading6">Reading</label>
                                    <input id="reading6" name="reading6" type="number" class="form-control" step=".1">
                                </div>
                                <div class="form-group formFields">
                                    <label for="measurement2">Units</label>
                                    <select class="form-control" id="measurement2" name="measurement2">
                                        <option value="mgdL">mg/dL</option>
                                        <option value="mmolL">mmol/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="submitBtn" class="mt-3 btn btn-primary" type="submit">Upload</button>
                </div>
            </div>
        </form>
    </div>
    <!-- End Upload Area -->
    <img id="imagePreview" style="height: 1px;" />
{% else %}
<h1>Index Page</h1>
    <p>You are not logged in</p>
    <a href="{% url 'Main:login' %}">Log In</a>
{% endif %}
</div>
<script>
    // Select Upload-Area
    const uploadArea = document.querySelector('#uploadArea');
    const uploadArea2 = document.querySelector('#uploadArea2');
    const uploadArea3 = document.querySelector('#uploadArea3');
    // Select Drop-Zoon Area
    const dropZoon = document.querySelector('#dropZoon');
    const dropZoon2 = document.querySelector('#dropZoon2');
    const dropZoon3 = document.querySelector('#dropZoon3');
    // Loading Text
    const loadingText = document.querySelector('#loadingText');
    const loadingText2 = document.querySelector('#loadingText2');
    const loadingText3 = document.querySelector('#loadingText3');
    // Slect File Input 
    const fileInput = document.querySelector('#fileInput');
    const fileInput2 = document.querySelector('#fileInput2');
    const fileInput3 = document.querySelector('#fileInput3');
    // Select Preview Image
    const previewImage = document.querySelector('#previewImage');
    const previewImage2 = document.querySelector('#previewImage2');
    const previewImage3 = document.querySelector('#previewImage3');
    // File-Details Area
    const fileDetails = document.querySelector('#fileDetails');
    const fileDetails2 = document.querySelector('#fileDetails2');
    const fileDetails3 = document.querySelector('#fileDetails3');
    // Uploaded File
    const uploadedFile = document.querySelector('#uploadedFile');
    const uploadedFile2 = document.querySelector('#uploadedFile2');
    const uploadedFile3 = document.querySelector('#uploadedFile3');
    // Uploaded File Info
    const uploadedFileInfo = document.querySelector('#uploadedFileInfo');
    const uploadedFileInfo2 = document.querySelector('#uploadedFileInfo2');
    const uploadedFileInfo3 = document.querySelector('#uploadedFileInfo3');
    // Uploaded File Name
    const uploadedFileName = document.querySelector('.uploaded-file__name');
    const uploadedFileName2 = document.querySelector('.uploaded-file__name2');
    const uploadedFileName3 = document.querySelector('.uploaded-file__name3');
    // Uploaded File Counter
    const uploadedFileCounter = document.querySelector('.uploaded-file__counter');
    const uploadedFileCounter2 = document.querySelector('.uploaded-file__counter2');
    const uploadedFileCounter3 = document.querySelector('.uploaded-file__counter3');
    // ToolTip Data
    const toolTipData = document.querySelectorAll('.upload-area__tooltip-data');
    // Images Types
    const imagesTypes = [ "jpeg", "png", "svg"]
    // Append Images Types Array Inisde Tooltip Data
    for (var i of toolTipData) {
        i.innerHTML = [...imagesTypes].join(', .');
    }

    // When (drop-zoon) has (dragover) Event 
    dropZoon.addEventListener('dragover', function (event) {
        // Prevent Default Behavior 
        event.preventDefault();
        // Add Class (drop-zoon--over) On (drop-zoon)
        dropZoon.classList.add('drop-zoon--over');
    })
    dropZoon2.addEventListener('dragover', function (event) {
        event.preventDefault();
        dropZoon2.classList.add('drop-zoon--over');
    })
    dropZoon3.addEventListener('dragover', function (event) {
        event.preventDefault();
        dropZoon3.classList.add('drop-zoon--over');
    })

    // When (drop-zoon) has (dragleave) Event 
    dropZoon.addEventListener('dragleave', function () {
        // Remove Class (drop-zoon--over) from (drop-zoon)
        dropZoon.classList.remove('drop-zoon--over');
    })
    dropZoon2.addEventListener('dragleave', function () {
        dropZoon2.classList.remove('drop-zoon--over');
    })
    dropZoon3.addEventListener('dragleave', function () {
        dropZoon3.classList.remove('drop-zoon--over');
    })

    // When (drop-zoon) has (click) Event 
    dropZoon.addEventListener('click', function () {
    // Click The (fileInput)
        fileInput.click();
    })
    dropZoon2.addEventListener('click', function () {
        fileInput2.click();
    })
    dropZoon3.addEventListener('click', function () {
        fileInput3.click();
    })

    // When (fileInput) has (change) Event 
    fileInput.addEventListener('change', function (event) {
        // Select The Chosen File
        const file = event.target.files[0];
        //console.log(event.target.files[0])
        // Call Function uploadFile(), And Send To Her The Chosen File :)
        //uploadFile(file);
        //readURL2(event.target.files[0])
    })
    fileInput2.addEventListener('change', function (event) {
        const file = event.target.files[0];
        uploadFile2(file);
    })
    fileInput3.addEventListener('change', function (event) {
        //const file = event.target.files[0];
        //uploadFile3(file);
    })

    var now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    now.setMilliseconds(null)
    now.setSeconds(null)

    function subtractHours(date, hours) {
        date.setHours(date.getHours() - hours);
    return date;
}
    $('#dateTimePicker2,#dateTimePicker3').val(now.toISOString().slice(0, -1));
    $('#dateTimePicker').val(subtractHours(now, 2).toISOString().slice(0, -1));

    $('form').on('submit', function(event) {
        var input_lst = [
            'reading',
            'reading2',
            'reading3',
            'reading4',
            'reading5',
            'reading6',
            'reading7'
        ]
        var check_forms = true
        for (var i of input_lst) {
            if ($('#' + i).val() == "") {
                check_forms = false
                break
            }
        }
        if (!check_forms) {
            event.preventDefault()
            alert('Please fill up all the input fields!')
            return
        }
    })

    const URL = 'https://teachablemachine.withgoogle.com/models/TqnQPSTyE/';
    let model, labelContainer, maxPredictions;


    // Load the image model 
    async function init() {
        var modelURL = URL + 'model.json';
        var metadataURL = URL + 'metadata.json';

        // load the model and metadata
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        labelContainer = document.getElementById('label-container');
        for (let i = 0; i < maxPredictions; i++) {
            // and class labels
            labelContainer.appendChild(document.createElement('div'));
        }
    }
  

    async function predict() {
				// predict can take in an image, video or canvas html element
				var finalClass = "";
				var finalPrediction = 0;
				var image = document.getElementById('previewImage2');
				var prediction = await model.predict(image, false);
				for (let i = 0; i < maxPredictions; i++) {
					//const classPrediction =
					//	prediction[i].className + ': ' + prediction[i].probability.toFixed(2);
					//labelContainer.childNodes[i].innerHTML = classPrediction;
					if (prediction[i].probability.toFixed(2)>finalPrediction){
						finalPrediction=prediction[i].probability;
						finalClass = prediction[i].className;
					}
				}
				console.log(finalClass)
				console.log(finalPrediction)
				const options = {
				method: 'GET',
				headers: {
							'X-RapidAPI-Key': '81001da94fmsh676baf96bcc26fcp155d7bjsn3e84e084918d',
							'X-RapidAPI-Host': 'edamam-recipe-search.p.rapidapi.com'
						}
					};

		fetch('https://edamam-recipe-search.p.rapidapi.com/search?q='+finalClass, options)
			.then(response => response.json())
			.then(response => {console.log(response.hits[0].recipe);
			console.log(response.hits[0].recipe.totalNutrients.SUGAR.quantity,response.hits[0].recipe.totalNutrients.SUGAR.unit);
			console.log(response.hits[0].recipe.totalNutrients.CHOCDF.quantity,response.hits[0].recipe.totalNutrients.CHOCDF.unit)
			console.log(response.hits[0].recipe.totalNutrients.FIBTG.quantity,response.hits[0].recipe.totalNutrients.FIBTG.unit)
			console.log(response.hits[0].recipe.totalNutrients.ENERC_KCAL.unit,response.hits[0].recipe.totalNutrients.ENERC_KCAL.quantity)
            
            document.getElementById('reading2').value=response.hits[0].recipe.totalNutrients.ENERC_KCAL.quantity.toFixed(1)
            document.getElementById('reading3').value=response.hits[0].recipe.totalNutrients.CHOCDF.quantity.toFixed(1)
            document.getElementById('reading4').value=response.hits[0].recipe.totalNutrients.SUGAR.quantity.toFixed(1)
            document.getElementById('reading5').value=response.hits[0].recipe.totalNutrients.FIBTG.quantity.toFixed(1)
            document.getElementById('reading7').value = finalClass
			//sugar carbs fibre and calories
			})
		
			.catch(err => console.error(err));

			}
        function readURL(input) {
            console.log(typeof(input))
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').attr('src', e.target.result);
                    // $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                    $('#imagePreview').hide();
                    $('#imagePreview').fadeIn(650);
                };
                reader.readAsDataURL(input.files[0]);
                init().then(() => {
                    predict();
                });
            }
        }

   

        $('#fileInput2').change(function () {
            readURL(this);
        });


        // Upload File Function
        function uploadFile(file) {
            console.log(file)
            let that = this;
            let formData = new FormData()
            formData.append('image', file)
            fetch("{% url 'CBG:read_CBG' %}", { 
                method: 'POST',
                body: formData 
            })
            .then (response => response.json())
            .then (data => {
                $('#reading').val(data.reading);
                $('#measurement').val(data.measurement)
                // FileReader()
                const fileReader = new FileReader();
                // File Type 
                const fileType = file.type;
                // File Size 
                const fileSize = file.size;
                // If File Is Passed from the (File Validation) Function
                if (fileValidate(fileType, fileSize)) {
                    // Add Class (drop-zoon--Uploaded) on (drop-zoon)
                    dropZoon.classList.add('drop-zoon--Uploaded');
                    // Show Loading-text
                    loadingText.style.display = "block";
                    // Hide Preview Image
                    previewImage.style.display = 'none';
                    // Remove Class (uploaded-file--open) From (uploadedFile)
                    uploadedFile.classList.remove('uploaded-file--open');
                    // Remove Class (uploaded-file__info--active) from (uploadedFileInfo)
                    uploadedFileInfo.classList.remove('uploaded-file__info--active');
                    // After File Reader Loaded 
                    fileReader.addEventListener('load', function () {
                    // After Half Second 
                        setTimeout(function () {
                                // Add Class (upload-area--open) On (uploadArea)
                                uploadArea.classList.add('upload-area--open');
                                // Hide Loading-text (please-wait) Element
                                loadingText.style.display = "none";
                                // Show Preview Image
                                previewImage.style.display = 'block';
                                // Add Class (file-details--open) On (fileDetails)
                                fileDetails.classList.add('file-details--open');
                                // Add Class (uploaded-file--open) On (uploadedFile)
                                uploadedFile.classList.add('uploaded-file--open');
                                // Add Class (uploaded-file__info--active) On (uploadedFileInfo)
                                uploadedFileInfo.classList.add('uploaded-file__info--active');
                            }, 500) // 0.5s
                            // Add The (fileReader) Result Inside (previewImage) Source
                            previewImage.setAttribute('src', fileReader.result);
                            // Add File Name Inside Uploaded File Name
                            uploadedFileName.innerHTML = file.name;
                            // Call Function progressMove();
                            progressMove();
                        })
                        // Read (file) As Data Url 
                        fileReader.readAsDataURL(file);
                    } else { // Else
                        this; // (this) Represent The fileValidate(fileType, fileSize) Function
                    }            
            })
            .catch(error => {
                alert("Unable to get reading from your BEFORE MEAL picture, please try another image thank you!")
            })
        }
        function uploadFile2(file) {
            // FileReader()
            const fileReader = new FileReader();
            // File Type 
            const fileType = file.type;
            // File Size 
            const fileSize = file.size;
            // If File Is Passed from the (File Validation) Function
            if (fileValidate(fileType, fileSize)) {
                // Add Class (drop-zoon--Uploaded) on (drop-zoon)
                dropZoon2.classList.add('drop-zoon--Uploaded');
                // Show Loading-text
                loadingText2.style.display = "block";
                // Hide Preview Image
                previewImage2.style.display = 'none';
                // Remove Class (uploaded-file--open) From (uploadedFile)
                uploadedFile2.classList.remove('uploaded-file--open');
                // Remove Class (uploaded-file__info--active) from (uploadedFileInfo)
                uploadedFileInfo2.classList.remove('uploaded-file__info--active');
                // After File Reader Loaded 
                fileReader.addEventListener('load', function () {
                // After Half Second 
                    setTimeout(function () {
                            // Add Class (upload-area--open) On (uploadArea)
                            uploadArea2.classList.add('upload-area--open');
                            // Hide Loading-text (please-wait) Element
                            loadingText2.style.display = "none";
                            // Show Preview Image
                            previewImage2.style.display = 'block';
                            // Add Class (file-details--open) On (fileDetails)
                            fileDetails2.classList.add('file-details--open');
                            // Add Class (uploaded-file--open) On (uploadedFile)
                            uploadedFile2.classList.add('uploaded-file--open');
                            // Add Class (uploaded-file__info--active) On (uploadedFileInfo)
                            uploadedFileInfo2.classList.add('uploaded-file__info--active');
                        }, 500) // 0.5s
                        // Add The (fileReader) Result Inside (previewImage) Source
                        previewImage2.setAttribute('src', fileReader.result);
                        // Add File Name Inside Uploaded File Name
                        uploadedFileName2.innerHTML = file.name;
                        // Call Function progressMove();
                        progressMove2();
                    })
                    // Read (file) As Data Url 
                    fileReader.readAsDataURL(file);
                } else { // Else
                    this; // (this) Represent The fileValidate(fileType, fileSize) Function
                }
        }
        function uploadFile3(file) {
            let formData = new FormData()
            formData.append('image', file)
            fetch("{% url 'CBG:read_CBG' %}", { 
                method: 'POST',
                body: formData 
            })
            .then (response => response.json())
            .then (data => {
                $('#reading6').val(data.reading);
                $('#measurement2').val(data.measurement)
                // FileReader()
                const fileReader = new FileReader();
                // File Type 
                const fileType = file.type;
                // File Size 
                const fileSize = file.size;
                // If File Is Passed from the (File Validation) Function
                if (fileValidate(fileType, fileSize)) {
                    // Add Class (drop-zoon--Uploaded) on (drop-zoon)
                    dropZoon3.classList.add('drop-zoon--Uploaded');
                    // Show Loading-text
                    loadingText3.style.display = "block";
                    // Hide Preview Image
                    previewImage3.style.display = 'none';
                    // Remove Class (uploaded-file--open) From (uploadedFile)
                    uploadedFile3.classList.remove('uploaded-file--open');
                    // Remove Class (uploaded-file__info--active) from (uploadedFileInfo)
                    uploadedFileInfo3.classList.remove('uploaded-file__info--active');
                    // After File Reader Loaded 
                    fileReader.addEventListener('load', function () {
                    // After Half Second 
                        setTimeout(function () {
                                // Add Class (upload-area--open) On (uploadArea)
                                uploadArea3.classList.add('upload-area--open');
                                // Hide Loading-text (please-wait) Element
                                loadingText3.style.display = "none";
                                // Show Preview Image
                                previewImage3.style.display = 'block';
                                // Add Class (file-details--open) On (fileDetails)
                                fileDetails3.classList.add('file-details--open');
                                // Add Class (uploaded-file--open) On (uploadedFile)
                                uploadedFile3.classList.add('uploaded-file--open');
                                // Add Class (uploaded-file__info--active) On (uploadedFileInfo)
                                uploadedFileInfo3.classList.add('uploaded-file__info--active');
                            }, 500) // 0.5s
                            // Add The (fileReader) Result Inside (previewImage) Source
                            previewImage3.setAttribute('src', fileReader.result);
                            // Add File Name Inside Uploaded File Name
                            uploadedFileName3.innerHTML = file.name;
                            // Call Function progressMove();
                            progressMove3();
                        })
                        // Read (file) As Data Url 
                        fileReader.readAsDataURL(file);
                } else { // Else
                    this; // (this) Represent The fileValidate(fileType, fileSize) Function
                }
            })
            .catch(error => {
                alert("Unable to get reading from your AFTER MEAL picture, please try another image thank you!")
            })        
        }

        // Progress Counter Increase Function
        function progressMove() {
            // Counter Start
            let counter = 0;
            // After 600ms 
            setTimeout(() => {
                // Every 100ms
                let counterIncrease = setInterval(() => {
                // If (counter) is equle 100 
                if (counter === 100) {
                    // Stop (Counter Increase)
                    clearInterval(counterIncrease);
                } else { // Else
                    // plus 10 on counter
                    counter = counter + 10;
                    // add (counter) vlaue inisde (uploadedFileCounter)
                    uploadedFileCounter.innerHTML = `${counter}%`
                }
                }, 100)
            }, 600)
        }
        function progressMove2() {
            let counter = 0;
            setTimeout(() => {
                let counterIncrease = setInterval(() => {
                if (counter === 100) {
                    clearInterval(counterIncrease);
                } else {
                    counter = counter + 10;
                    uploadedFileCounter2.innerHTML = `${counter}%`
                }
                }, 100)
            }, 600)
        }
        function progressMove3() {
            let counter = 0;
            setTimeout(() => {
                let counterIncrease = setInterval(() => {
                if (counter === 100) {
                    clearInterval(counterIncrease);
                } else {
                    counter = counter + 10;
                    uploadedFileCounter3.innerHTML = `${counter}%`
                }
                }, 100)
            }, 600)
        }

        // Simple File Validate Function
        function fileValidate(fileType, fileSize) {
            // File Type Validation
            let isImage = imagesTypes.filter((type) => fileType.indexOf(`image/${type}`) !== -1);
            // If The Uploaded File Is An Image
            if (isImage.length !== 0) {
                // Check, If File Size Is 2MB or Less
                if (fileSize <= 3000000) { // 3MB :)
                    return true;
                } else { // Else File Size
                    return alert('Please Your File Should be 2 Megabytes or Less');
                }
            } else { // Else File Type 
                return alert('Please make sure to upload An Image File Type');
            }
        }

    var readings = {{readings|safe}}
    var cbg_datetime = {{cbg_datetime|safe}}
    // console.log(readings)
    // console.log(cbg_datetime)

</script>
<script>
    const URL2 = 'https://teachablemachine.withgoogle.com/models/Kk_HvtZ1P/';
    
    let model2, labelContainer2, maxPredictions2;
    
    // Load the image model 
    async function init2() {
        const modelURL2 = URL2 + 'model.json';
        const metadataURL2 = URL2 + 'metadata.json';
    
        // load the model and metadata
        model2 = await tmImage.load(modelURL2, metadataURL2);
        maxPredictions = model2.getTotalClasses();
    
        labelContainer = document.getElementById('label-container');
        for (let i = 0; i < maxPredictions2; i++) {
            // and class labels
            labelContainer.appendChild(document.createElement('div'));
        }

    }
    
    async function predict2(event) {
        // predict can take in an image, video or canvas html element
        var image = document.getElementById('imagePreview');
        const prediction2 = await model2.predict(image, false);
        var finalDesc = "";
        //console.log(image)
        for (let i = 0; i < maxPredictions2; i++) {
            const classPrediction2 =
                prediction2[i].className + ': ' + prediction2[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction2;
        }
        //console.log(prediction2)
        finalDesc=prediction2[0]
        for(let i =0; i<maxPredictions2;i++){
            //console.log(prediction2[i])
            if(prediction2[i].probability>finalDesc){
                finalDesc=prediction2[i]
            }
        }
        //console.log(finalDesc)
        if(finalDesc.className=="CBG Reading"){
            uploadFile(event.target.files[0])
        }
        //console.log(event.target.files[0])
    }

    async function predict3(event) {
        // predict can take in an image, video or canvas html element
        var image = document.getElementById('imagePreview');
        const prediction2 = await model2.predict(image, false);
        //console.log(image)
        var finalDesc=""
        for (let i = 0; i < maxPredictions2; i++) {
            const classPrediction2 =
                prediction2[i].className + ': ' + prediction2[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction2;
        }
        //console.log(prediction2)
        finalDesc=prediction2[0]
        for(let i =0; i<maxPredictions2;i++){
           // console.log(prediction2[i])
            if(prediction2[i].probability>finalDesc){
                finalDesc=prediction2[i]
            }
        }
        //console.log(finalDesc)
        if(finalDesc.className=="CBG Reading"){
            uploadFile3(event.target.files[0])
        }
        
        //console.log(event.target.files[0])
    }

        function readURL2(input,event) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').attr('src', e.target.result);
                    // $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                    $('#imagePreview').hide();
                    $('#imagePreview').fadeIn(650);
                };
                reader.readAsDataURL(input.files[0]);
                init2().then(() => {
                    predict2(event);
                });
            }
        }
        function readURL3(input,event) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').attr('src', e.target.result);
                    // $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                    $('#imagePreview').hide();
                    $('#imagePreview').fadeIn(650);
                };
                reader.readAsDataURL(input.files[0]);
                init2().then(() => {
                    predict3(event);
                });
            }
        }

        $('#fileInput').change(function (event) {
            readURL2(this,event);
        });
        $('#fileInput3').change(function (event) {
            readURL3(this,event);
        });


    </script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

{% endblock %}

