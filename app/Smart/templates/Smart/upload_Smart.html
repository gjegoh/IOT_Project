{% extends 'Food/base.html' %}
{% load static %}

{% block head %}
{% block title %}Smart Upload{% endblock %}
{% endblock %}

{% block body %}
    {% if user.is_authenticated %}
        <h1>Smart Upload</h1>
        <p><a href="{% url 'Main:index' %}">Home</a></p>
        <p><a href="{% url 'CBG:upload_CBG' %}">Upload CBG</a></p>
        <p><a href="{% url 'Food:upload_Food' %}">Upload Food</a></p>
        <form method="POST" enctype="multipart/form-data" action="">
            <label for="img">Select image:</label>
            <input type="file" id="img" name="img" accept="image/*">
            <br><button type="submit">Upload</button>
        </form>


        <img id="imagePreview" style="height: 300px;" />
		<input id="imageUpload" type="file" />

		<div>Teachable Machine Image Model with upload</div>
		<div id="label-container"></div>

        <p><a href="{% url 'Main:logout' %}">Log Out</a></p>
    {% else %}
    <h1>Index Page</h1>
        <p>You are not logged in</p>
        <a href="{% url 'Main:login' %}">Log In</a>
    {% endif %} 
    <script src="{% static 'Smart/js/script.js' %}"></script>


    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
        const URL = 'https://teachablemachine.withgoogle.com/models/tPCPE7VXk/';

        let model, labelContainer, maxPredictions;

        // Load the image model 
        async function init() {
            const modelURL = URL + 'model.json';
            const metadataURL = URL + 'metadata.json';

            // load the model and metadata
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            labelContainer = document.getElementById('label-container');
            for (let i = 0; i < maxPredictions; i++) {
                // and class labels
                labelContainer.appendChild(document.createElement('div'));
            }
        }

        async function predict() {
            // predict can take in an image, video or canvas html element
            var image = document.getElementById('imagePreview');
            const prediction = await model.predict(image, false);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ': ' + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }
            console.log(prediction[0])
            console.log(prediction[1])
            if (prediction[0].probability>prediction[1].probability){
                console.log(prediction[0])
            }else{
                console.log(prediction[1])
            }
        }
			function readURL(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();
					reader.onload = function (e) {
						$('#imagePreview').attr('src', e.target.result);
						// $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
						$('#imagePreview').hide();
						$('#imagePreview').fadeIn(650);
					};
					reader.readAsDataURL(input.files[0]);
					init().then(() => {
						predict();
					});
				}
			}
			$('#imageUpload').change(function () {
				readURL(this);
			});
    </script>
{% endblock %}

